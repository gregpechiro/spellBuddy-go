<!doctype html>
<html lang="en">
	<head>
		<title></title>
		{{ template "head.tmpl" . }}

	</head>
	<body>
			{{ template "nav.tmpl" . }}
        <div class="container">
			{{ template "alerts.tmpl" . }}
            <div class="row">
                <div class="col-lg-offset-1 col-lg-10">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                Power Points
                            </h4>
                        </div>
                        <div class="panel-body">
                            <div class="text-center">
                                <label>Total Power Points: &nbsp;</label>{{ .setup.TotalPowerPoints }}<br>
                                <label>Remaining Power Points: &nbsp;</label><span id="remaining-pp">{{ .setup.RemainingPowerPoints }}</span>
                            </div>
                            <div class="col-lg-offset-1 col-lg-10">
								<form action="/pp-rest" method="post">
									<input type="hidden" name="userId" value="{{ .user.Id }}">
									<input type="hidden" name="setupId" value="{{ .setup.Id }}">
                                	<button class="btn btn-primary btn-block" data-toggle="collapse" data-target="#prepareCollapse">Rest</button>
								</form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-offset-1 col-lg-10">
                    <div class="panel-group" id="spellsAccordion" role="tablist" aria-multiselectable="true">
						{{ $setup := .setup}}
						{{ range $level, $spells := .picked }}
							{{ $len := len $spells }}
							{{ if gt $len 0 }}
		                        <div class="panel panel-default">
		                            <div class="panel-heading" >
		                                <h4 class="panel-title">
		                                    <a data-toggle="collapse" data-parent="#spellsAccordion" data-target="#level-{{ $level }}-colapse" style="cursor:pointer;">
		                                        Level {{ $level }} Spells
		                                    </a>
		                                </h4>
		                            </div>
		                            <div id="level-{{ $level }}-colapse" class="panel-collapse collapse">
										<div class="panel-body level-panel">
				                            <div class="panel-group" id="level-{{ $level }}-accordian" role="tablist">
												{{ range $spell := $spells}}
					                                <div class="panel panel-default" >
					                                    <div class="panel-heading" role="tab" id="heading-{{ $level }}-inner">
					                                        <h4 class="panel-title clearfix">
					                                            <a data-toggle="collapse" class="col-lg-6" data-parent="#level-{{ $level }}-accordian" data-target="#spell-{{ $level }}-{{ $spell.Id }}-colapse" style="cursor:pointer;">
					                                                {{ $spell.Name }}
					                                            </a>
																<form class="pull-right col-lg-4 cast" action="/pp-cast" method="post">
																	<input type="hidden" name="setupId" value="{{ $setup.Id }}">
                                                                	<div class="input-group input-group-sm">
                                                                    	<input type="text" name="pp" class="form-control" placeholder="Points">
                                                                    	<span class="input-group-btn">
                                                                        	<button class="btn btn-default cast" {{if lt $setup.RemainingPowerPoints 1 }}disabled="disabled"{{ end }}>Cast</button>
                                                                    	</span>
                                                                	</div>
																</form>
					                                        </h4>
					                                    </div>
					                                    <div id="spell-{{ $level }}-{{ $spell.Id }}-colapse" class="panel-collapse collapse">
					                                        <div class="panel-body">
					                                            <h4>{{ $spell.School }}
																	{{ if $spell.Subschool }}<span> ({{ $spell.Subschool }})</span>{{ end }}
																	{{ if $spell.Descriptors }}<span> [{{ $spell.Descriptors }}]</span>{{ end }}
																</h4>
					                                            <p>
					                                                {{ $spell.Rulebook }}{{ if $spell.Page  }}<span> p. {{ $spell.Page }}</span>{{ end }}
					                                            </p>
					                                            <table>
					                                                <tbody>
					                                                    {{ if $spell.CastingTime }}<tr><td class="text-right"><strong>Components:</strong> &nbsp;</td><td class="text-left">{{ $spell.Components }}</td></tr>{{ end }}
					                                                    {{ if $spell.CastingTime }}<tr><td class="text-right"><strong>Casting Time:</strong> &nbsp;</td><td class="text-left">{{ $spell.CastingTime }}</td></tr>{{ end }}
					                                                    {{ if $spell.SpellRange }}<tr><td class="text-right"><strong>Range:</strong> &nbsp;</td><td class="text-left">{{ $spell.SpellRange }}</td></tr>{{ end }}
					                                                    {{ if $spell.Area }}<tr><td class="text-right"><strong>Area:</strong> &nbsp;</td><td class="text-left">{{ $spell.Area }}</td></tr>{{ end }}
					                                                    {{ if $spell.Effect }}<tr><td class="text-right"><strong>Effect:</strong> &nbsp;</td><td class="text-left">{{ $spell.Effect }}</td></tr>{{ end }}
					                                                    {{ if $spell.Target }}<tr><td class="text-right"><strong>Target:</strong> &nbsp;</td><td class="text-left">{{ $spell.Target }}</td></tr>{{ end }}
					                                                    {{ if $spell.Duration }}<tr><td class="text-right"><strong>Duration:</strong> &nbsp;</td><td class="text-left">{{ $spell.Duration }}</td></tr>{{ end }}
					                                                    {{ if $spell.SavingThrow }}<tr><td class="text-right"><strong>Saving Throw:</strong> &nbsp;</td><td class="text-left">{{ $spell.SavingThrow }}</td></tr>{{ end }}
					                                                    {{ if $spell.SpellResistance }}<tr><td class="text-right"><strong>Spell Resistance:</strong> &nbsp;</td><td class="text-left">{{ $spell.SpellResistance }}</td></tr>{{ end }}
					                                                </tbody>
					                                            </table>
					                                            <br>
					                                            <span>
																	<div {{ if $spell.Custom }}class="description"{{ end }}>{{ $spell.DescriptionHtml }}</div>
																</span>
					                                        </div>
					                                    </div>
					                                </div>
												{{ end }}
				                            </div>
				                        </div>
		                            </div>
		                        </div>
							{{ end }}
						{{ end }}
                    </div>
                </div>
            </div>
        </div>
		{{ template "scripts.tmpl" }}
		<script src="/static/js/util.js" charset="utf-8"></script>
		<script type="text/javascript">

			$(document).ready(function() {
				$('form.cast').submit(function(e) {
					e.preventDefault();
					$.ajax({
			            type: 'POST',
			            url: '/pp-cast',
			            data: $(this).serialize(),
			            success: function(resp) {
			                if (!resp.success) {
			                    showError(resp.msg);
			                    return
			                }
							$('span#remaining-pp').text(resp.remaining);
							if (resp.remaining < 1) {
								$('button.cast').attr('disabled', 'disabled');
							}
			            },
			            error: function() {
			                showError("Error casting spell");
			            }
			        });
				});
			});
		</script>
	</body>
</html>
