<!doctype html>
<html lang="en">
	<head>
		<title></title>
		{{ template "head.tmpl" . }}

	</head>
	<body>
		{{ template "nav.tmpl" . }}
        <div class="container">

			{{ template "alerts.tmpl" . }}

            <div class="row">
                <div class="col-lg-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h4 class="panel-title">
                                Spells
                            </h4>
                        </div>
                        <div class="panel-body">
                            <div class="row text-center">
								{{ range $i, $v := .setup.SpellsPerDay}}
                                	<div class="col-lg-2 {{ if eq $i 0 5 }}col-lg-offset-1{{ end }} col-xs-6">
                                    	<strong>Level {{ $i }}:</strong> {{ $v }}/Day
                                	</div>
								{{ end }}
                            </div>
                            <br>
                            <div class="panel-group" id="prepareAccordion" role="tablist" aria-multiselectable="true">
                                <div class="panel panel-default">
                                    <div class="panel-heading" role="tab" id="headingPrepare">
                                        <h4 class="panel-title">
                                            <a data-toggle="collapse" data-parent="#prepareAccordion" data-target="#prepareCollapse" style="cursor:pointer;">
                                                Prepare Spells
                                            </a>
                                        </h4>
                                    </div>
                                    <div id="prepareCollapse" class="panel-collapse collapse">
                                        <div class="panel-body">
                                            <div class="row text-center">
												<div id="picked1" class="row">
													{{ $prepared := .setup.PreparedSpells }}
													{{ $spd := .setup.SpellsPerDay}}
													{{ range $level, $spells := .picked }}
															{{ $prepLvl := index $prepared $level }}
															{{ $spdLvl := index $spd $level }}
		                                                	<div class="col-lg-2 col-xs-12 {{ if eq $level 0 5 }}col-lg-offset-1{{ end }}" style="padding:5px;">
																<div class="col-xs-12 level" style="border: 1px solid white;">
		                                                    	<label>Level {{ $level }}</label>
																{{ if not $spells}}<p>No Spells</p>{{ end }}
																{{ range $spell := $spells }}
		                                                    		<div class="checkbox text-left">
		                                                        		<label>
		                                                        			<input type="checkbox" class="prepare prepare-{{ $level }}" data-level="{{ $level }}" data-spell-id="{{ $spell.Id }}" {{ if isIn $prepLvl $spell.Id }}checked{{ else if len $prepLvl | eq $spdLvl }}disabled="disabled"{{ end }}>{{ $spell.Name }}
		                                                        		</label>
		                                                    		</div>
																{{ end }}
																</div>
		                                                	</div>
															{{ if eq $level 4 }}
												</div>
												<div id="picked2" class="row">
															{{ end }}
													{{ end }}
												</div>
												<div class="row">
                                                	<div class="col-lg-offset-1 col-lg-10 col-xs-12" style="padding:5px;">
														<form id="rest" action="/rest" method="post">
															<input type="hidden" name="userId" value="{{ .user.Id }}">
															<input type="hidden" name="setupId" value="{{ .setup.Id }}">
															<input type="hidden" name="prepared">
	                                                    	<button id="rest" class="btn btn-primary btn-block" style="margin-top:10px;">Rest</button>
														</form>
                                                	</div>
												</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row" style="margin-bottom:20px;">
                <div class="col-lg-12">
                    <div class="panel-group" id="spellsAccordion" role="tablist" aria-multiselectable="true">
						{{ $setup := .setup }}
						{{ $remaining := .setup.RemainingSpells }}
						{{ range $level, $spells := .picked }}
							{{ $len := len $spells }}
							{{ if gt $len 0 }}
								{{ $remainingLvl := index $remaining $level }}
								{{ $prepLvl := index $prepared $level }}
		                        <div class="panel panel-default">
		                            <div class="panel-heading" >
		                                <h4 class="panel-title">
		                                    <a data-toggle="collapse" data-parent="#spellsAccordion" data-target="#level-{{ $level }}-colapse" style="cursor:pointer;">
		                                        Level {{ $level }} Spells
		                                    </a>
		                                    <span class="pull-right"><span id="remaining-{{ $level }}">{{ index $setup.RemainingSpells $level }}</span> Spells left today</span>
		                                </h4>
		                            </div>
		                            <div id="level-{{ $level }}-colapse" class="panel-collapse collapse">
										<div class="panel-body level-panel">
				                            <div class="panel-group" id="level-{{ $level }}-accordian" role="tablist">
												{{ range $spell := $spells}}
					                                <div class="panel panel-default">
					                                    <div class="panel-heading" role="tab" id="heading-{{ $level }}-inner">
					                                        <h4 class="panel-title clearfix">
					                                            <a data-toggle="collapse" class="col-lg-6" data-parent="#level-{{ $level }}-accordian" data-target="#spell-{{ $level }}-{{ $spell.Id }}-colapse" style="cursor:pointer;">
					                                                {{ $spell.Name }}
					                                            </a>
																<div class="col-lg-1 col-lg-offset-5 pull-right">
																	{{ $in := isIn $prepLvl $spell.Id }}
																	{{ $hasRemaining := gt $remainingLvl 0 }}
																	<form action="/cast" class="cast" method="post">
																		<input type="hidden" name="level" value="{{ $level }}">
																		<input type="hidden" name="setupId" value="{{ $setup.Id }}">
					                                            		<button class="btn btn-default btn-xs cast-{{ $level }}"{{ if eq false $in $hasRemaining }}disabled="disabled"{{ end }}>Cast</button>
																	</form>
																</div>
					                                        </h4>
					                                    </div>
					                                    <div id="spell-{{ $level }}-{{ $spell.Id }}-colapse" class="panel-collapse collapse">
					                                        <div class="panel-body spell-panel">
					                                            <h4>{{ $spell.School }}
																	{{ if $spell.Subschool }}<span> ({{ $spell.Subschool }})</span>{{ end }}
																	{{ if $spell.Descriptors }}<span> [{{ $spell.Descriptors }}]</span>{{ end }}
																</h4>
					                                            <p ng-show="s.rulebook">
					                                                {{ $spell.Rulebook }}{{ if $spell.Page  }}<span> p. {{ $spell.Page }}</span>{{ end }}
					                                            </p>
					                                            <table>
					                                                <tbody>
					                                                    {{ if $spell.Components }}<tr><td class="text-right"><strong>Components:</strong> &nbsp;</td><td class="text-left">{{ $spell.Components }}</td></tr>{{ end }}
																		{{ if $spell.Displays }}<tr><td class="text-right"><strong>Displays:</strong> &nbsp;</td><td class="text-left">{{ $spell.Displays }}</td></tr>{{ end }}
					                                                    {{ if $spell.CastingTime }}<tr><td class="text-right"><strong>Casting Time:</strong> &nbsp;</td><td class="text-left">{{ $spell.CastingTime }}</td></tr>{{ end }}
					                                                    {{ if $spell.SpellRange }}<tr><td class="text-right"><strong>Range:</strong> &nbsp;</td><td class="text-left">{{ $spell.SpellRange }}</td></tr>{{ end }}
					                                                    {{ if $spell.Area }}<tr><td class="text-right"><strong>Area:</strong> &nbsp;</td><td class="text-left">{{ $spell.Area }}</td></tr>{{ end }}
					                                                    {{ if $spell.Effect }}<tr><td class="text-right"><strong>Effect:</strong> &nbsp;</td><td class="text-left">{{ $spell.Effect }}</td></tr>{{ end }}
					                                                    {{ if $spell.Target }}<tr><td class="text-right"><strong>Target:</strong> &nbsp;</td><td class="text-left">{{ $spell.Target }}</td></tr>{{ end }}
					                                                    {{ if $spell.Duration }}<tr><td class="text-right"><strong>Duration:</strong> &nbsp;</td><td class="text-left">{{ $spell.Duration }}</td></tr>{{ end }}
					                                                    {{ if $spell.SavingThrow }}<tr><td class="text-right"><strong>Saving Throw:</strong> &nbsp;</td><td class="text-left">{{ $spell.SavingThrow }}</td></tr>{{ end }}
					                                                    {{ if $spell.SpellResistance }}<tr><td class="text-right"><strong>Spell Resistance:</strong> &nbsp;</td><td class="text-left">{{ $spell.SpellResistance }}</td></tr>{{ end }}
					                                                </tbody>
					                                            </table>
					                                            <br>
					                                            <span>
																	<div {{ if $spell.Custom }}class="description"{{ end }}>{{ $spell.DescriptionHtml }}</div>
																</span>
					                                        </div>
					                                    </div>
					                                </div>
												{{ end }}
				                            </div>
				                        </div>
		                            </div>
		                        </div>
							{{ end }}
						{{ end }}
                    </div>
                </div>
            </div>
        </div>
		{{ template "scripts.tmpl" }}

		{{ template "timeout.tmpl" . }}

		<script src="/static/js/util.js" charset="utf-8"></script>
		<script type="text/javascript">
			var setHeight = false;

			var prepared = {{ if .setup.PreparedSpells }}{{ json .setup.PreparedSpells }}{{ else }}[[],[],[],[],[],[],[],[],[],[]]{{ end }};
			var spd = {{ if .setup.SpellsPerDay }}{{ json .setup.SpellsPerDay }}{{ else }}[0,0,0,0,0,0,0,0,0,0]{{ end }}
			$(document).ready(function() {
				$('form.cast').submit(function(e) {
					e.preventDefault();
					$.ajax({
			            type: 'POST',
			            url: '/cast',
			            data: $(this).serialize(),
			            success: function(resp) {
			                if (!resp.success) {
			                    showError(resp.msg);
			                    return
			                }
							$('span#remaining-' + resp.level).text(resp.remaining);
							if (resp.remaining < 1) {
								$('button.cast-' + resp.level).attr('disabled', 'disabled');
							}
			            },
			            error: function() {
			                showError("Error casting spell");
			            }
			        });
				});

				if (prepared == null) {
					prepared = [[],[],[],[],[],[],[],[],[],[]];
				}
				$('input.prepare').click(function() {
					level =+ $(this).attr('data-level');
					spellId = $(this).attr('data-spell-id');
					if (this.checked) {
						if (prepared[level] == null) {
							prepared[level] = [];
						}
						prepared[level].push(spellId);
						console.log(prepared[level].length == spd[level]);
						if (prepared[level].length == spd[level]) {
							cboxes = $('input.prepare-' + level);
							for (var i = 0; i < cboxes.length; i++) {
								if (!cboxes[i].checked) {
									$(cboxes[i]).attr('disabled', 'disabled');
								}
							}
						}
					} else {
						prepared[level] = removeValue(prepared[level], spellId);
						if (prepared[level].length < spd[level]) {
							$('input.prepare-' + level).removeAttr('disabled');
						}
					}
				});
				$('button#rest').click(function(e) {
					e.preventDefault();
					$('input[name="prepared"]').val(JSON.stringify(prepared));
					console.log($('input[name="prepared"]').val());
					$('form#rest').submit();
				});

				$('#prepareCollapse').on('show.bs.collapse', function() {
					if (!setHeight) {
						window.setTimeout(function() {

							var size = 0;
							var l = $('#picked1').find('.level');
							for (var i = 0; i < l.length; i++) {
		    					if ($(l[i]).height() > size) {
									size = $(l[i]).height();
								}
							}
							for (var i = 0; i < l.length; i++) {
								$(l[i]).height(size);
							}

							size = 0;
							l = $('#picked2').find('.level');
							for (var i = 0; i < l.length; i++) {
		    					if ($(l[i]).height() > size) {
									size = $(l[i]).height();
								}
							}
							for (var i = 0; i < l.length; i++) {
								$(l[i]).height(size);
							}
						}, 10)
					}

				});
			});
		</script>
	</body>
</html>
